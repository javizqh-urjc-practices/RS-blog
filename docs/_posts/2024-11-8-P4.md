---
title: "P4: Warehouse"
date: 2024-11-8 18:00:00 +0100
tags: [weekly progress]     # TAG names should always be lowercase
author: javier
img_path: /assets/img/
toc: true
comments: true
pin: true
---

## Fitting the map

In order to make the transformation from Gazebo to the image we need to complete this equation.

![Matrix](coord2pix.png)

For the rotation part it was pretty clear that it was 180 degrees because the pose in the start position is close to 0 degrees but in the image the angle should be 180ยบ.

And as we only want the x and y values we obtain the following 2 equations, note that the scales are different because the image is not square (415x279):

```math
x' = scale * (x*cos(a) +tx -y*sin(a))
```

```math
y' = scale' * (y*cos(a) +ty +x*sin(a))
```

Now we know that *a* equals to -1.24 rad.

```math
x' = scale * (0.32*x +tx +0.946*y)
```

```math
y' = scale' * (0.32*y +ty -0.946*x)
```

```math
x' = scale * (0.32*x + 149.7259 +0.946*y)
```

```math
y' = scale' * (0.32*y + 74.95 -0.946*x)
```


```math
x' = scale' * (ty - y)
```

```math
y' = scale * (tx - x)
```

So in order to find the remaining pieces I looked for the pose values in some of the corners of the house and thanks to knowing that the size of the vacuum cleaner is approximately 35 px I can get more or less the position of the vacuum cleaner in the image. The code I used to get those values is the following:

```python
import GUI
import HAL
import time

MAP = GUI.getMap('/RoboticsAcademy/exercises/static/exercises/vacuum_cleaner_loc_newmanager/resources/images/mapgrannyannie.png')

while True:
    pose = HAL.getPose3d()
    print(pose)
    time.sleep(5)
```

With that I got the next value pairs (the decimal values I gave it to them in order to guess better for the position when the vacuum cleaner was not agains a wall completely): [(0.93, -0.9) to (334.2, 481.9), (-3.73, 1.56) to (583.4, 953.7), (5.14, 5.556) to (987.9, 56.6) and (2.06, -3.31) to (89.9, 368.1)]

Now solving that equations system the results are:

```math
x' = -101.25 * (-4.2 - y)
```

```math
y' = 101.1 * (5.7 - x)
```

With that I can define the following function to change from pose to the map coordinates:

```python
def pose_to_map (pose):
    x = -101.25 * (-4.2 - pose.y)
    y =  101.1  * ( 5.7 - pose.x)
    
    return x, y
```

The only thing remaining is to do the opposite operation, from map to pose. So from the equations above we obtain:

```math
x = (y' - 576.27) / -101.1
```

```math
y = (x' - 425.25) / 101.25
```

So the function is:

```python
def map_to_pose (map_x, map_y):
  x = (map_y - 576.27) / -101.1
  y = (map_x - 425.25) /  101.25
  
  return x, y
```

## Videos

{% include embed/youtube.html id='6x2tEgzq5L8' %}
{% include embed/youtube.html id='apFzYNAjb5E' %}
{% include embed/youtube.html id='La5irIdjZiY' %}
{% include embed/youtube.html id='hUZJ4_7InAs' %}
